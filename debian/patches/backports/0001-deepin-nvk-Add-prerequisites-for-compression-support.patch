From 7499ff71b0e1323f05719b202bcbb14b731aaf02 Mon Sep 17 00:00:00 2001
From: WangYuli <wangyl5933@chinaunicom.cn>
Date: Fri, 19 Dec 2025 10:41:57 +0800
Subject: [PATCH 1/3] deepin: nvk: Add prerequisites for compression support
 backport

Add the following infrastructure needed to backport compression commits:

- nouveau_device: Add nouveau_version field to track kernel driver version
- nvk_image: Add can_compress and is_compressed fields
- nvk_device_memory: Add dedicated_image field and nvk_image forward declaration
- NIL image.rs: Add IMAGE_USAGE_UNCOMPRESSED_BIT flag and compressed_pte_kind field

These changes are required as prerequisites for the upstream compression
feature commits.

Signed-off-by: WangYuli <wangyl5933@chinaunicom.cn>
---
 src/nouveau/nil/image.rs               | 12 ++++++++++++
 src/nouveau/vulkan/nvk_device_memory.h |  5 +++++
 src/nouveau/vulkan/nvk_image.h         | 12 ++++++++++++
 src/nouveau/winsys/nouveau_device.c    |  2 ++
 src/nouveau/winsys/nouveau_device.h    |  5 +++++
 5 files changed, 36 insertions(+)

diff --git a/src/nouveau/nil/image.rs b/src/nouveau/nil/image.rs
index 3f4101fc3b4..73544224135 100644
--- a/src/nouveau/nil/image.rs
+++ b/src/nouveau/nil/image.rs
@@ -16,6 +16,7 @@ pub type ImageUsageFlags = u8;
 pub const IMAGE_USAGE_2D_VIEW_BIT: ImageUsageFlags = 1 << 0;
 pub const IMAGE_USAGE_LINEAR_BIT: ImageUsageFlags = 1 << 1;
 pub const IMAGE_USAGE_SPARSE_RESIDENCY_BIT: ImageUsageFlags = 1 << 2;
+pub const IMAGE_USAGE_UNCOMPRESSED_BIT: ImageUsageFlags = 1 << 3;
 
 #[derive(Clone, Debug, Copy, PartialEq, Default)]
 #[repr(u8)]
@@ -180,6 +181,7 @@ pub struct Image {
     pub compressed: bool,
     pub tile_mode: u16,
     pub pte_kind: u8,
+    pub compressed_pte_kind: u8,
 }
 
 impl Image {
@@ -253,6 +255,7 @@ impl Image {
             compressed: false,
             tile_mode: 0,
             pte_kind: 0,
+            compressed_pte_kind: 0,
             mip_tail_first_lod: 0,
         };
 
@@ -353,6 +356,15 @@ impl Image {
                 image.compressed,
             );
 
+            // Always compute compressed_pte_kind for potential future use
+            // (e.g., dedicated allocations with compression)
+            image.compressed_pte_kind = Self::choose_pte_kind(
+                dev,
+                info.format,
+                info.samples,
+                true, // compressed = true
+            );
+
             if info.modifier != DRM_FORMAT_MOD_INVALID {
                 let bl_mod =
                     BlockLinearModifier::try_from(info.modifier).unwrap();
diff --git a/src/nouveau/vulkan/nvk_device_memory.h b/src/nouveau/vulkan/nvk_device_memory.h
index 4d2f751f111..b0e665bd18f 100644
--- a/src/nouveau/vulkan/nvk_device_memory.h
+++ b/src/nouveau/vulkan/nvk_device_memory.h
@@ -13,10 +13,15 @@
 
 struct nvkmd_mem;
 
+struct nvk_image;
+
 struct nvk_device_memory {
    struct vk_device_memory vk;
 
    struct nvkmd_mem *mem;
+
+   /** Dedicated image for this memory allocation, if any */
+   struct nvk_image *dedicated_image;
 };
 
 VK_DEFINE_NONDISP_HANDLE_CASTS(nvk_device_memory, vk.base, VkDeviceMemory,
diff --git a/src/nouveau/vulkan/nvk_image.h b/src/nouveau/vulkan/nvk_image.h
index 1222485c935..9f876fdaa3e 100644
--- a/src/nouveau/vulkan/nvk_image.h
+++ b/src/nouveau/vulkan/nvk_image.h
@@ -79,6 +79,18 @@ struct nvk_image {
     */
    bool disjoint;
 
+   /** True if this image can be compressed
+    *
+    * This is set at image creation time based on image properties.
+    */
+   bool can_compress;
+
+   /** True if this image is actually compressed
+    *
+    * This is set at bind time when compression is enabled.
+    */
+   bool is_compressed;
+
    uint8_t plane_count;
    struct nvk_image_plane planes[3];
 
diff --git a/src/nouveau/winsys/nouveau_device.c b/src/nouveau/winsys/nouveau_device.c
index 925df476be9..4f7ea56d541 100644
--- a/src/nouveau/winsys/nouveau_device.c
+++ b/src/nouveau/winsys/nouveau_device.c
@@ -285,6 +285,8 @@ nouveau_ws_device_new(drmDevicePtr drm_device)
    drmFreeVersion(ver);
    ver = NULL;
 
+   device->nouveau_version = version;
+
    if (version < 0x01000301)
       goto out_err;
 
diff --git a/src/nouveau/winsys/nouveau_device.h b/src/nouveau/winsys/nouveau_device.h
index e986b2cfab6..1a480e69ba2 100644
--- a/src/nouveau/winsys/nouveau_device.h
+++ b/src/nouveau/winsys/nouveau_device.h
@@ -27,6 +27,11 @@ struct nouveau_ws_device {
    struct hash_table *bos;
 
    bool has_vm_bind;
+
+   /* Nouveau kernel driver version, packed as:
+    * (major << 24) | (minor << 8) | patchlevel
+    */
+   uint32_t nouveau_version;
 };
 
 struct nouveau_ws_device *nouveau_ws_device_new(struct _drmDevice *drm_device);
-- 
2.51.0


From 6191f0042ec5b025bfce1cb733d110b844751613 Mon Sep 17 00:00:00 2001
From: Mel Henning <mhenning@darkrefraction.com>
Date: Fri, 19 Dec 2025 10:46:38 +0800
Subject: [PATCH 3/3] nvk: Disable compression for image import/export

Reviewed-by: Mohamed Ahmed <mohamedahmedegypt2001@gmail.com>
Part-of: <https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/36450>
Signed-off-by: WangYuli <wangyl5933@chinaunicom.cn>
---
 src/nouveau/vulkan/nvk_device_memory.c | 15 +++++++++++----
 src/nouveau/vulkan/nvk_image.c         |  4 +++-
 2 files changed, 14 insertions(+), 5 deletions(-)

diff --git a/src/nouveau/vulkan/nvk_device_memory.c b/src/nouveau/vulkan/nvk_device_memory.c
index 5ca3243bb5e..3a40063caab 100644
--- a/src/nouveau/vulkan/nvk_device_memory.c
+++ b/src/nouveau/vulkan/nvk_device_memory.c
@@ -139,6 +139,7 @@ nvk_AllocateMemory(VkDevice device,
    if (fd_info != NULL)
       handle_types |= fd_info->handleType;
 
+   const bool not_shared = handle_types == 0;
    bool pinned_to_vram = false;
 
    /* Align to os page size (typically 4K) as a start as this works for
@@ -161,10 +162,16 @@ nvk_AllocateMemory(VkDevice device,
          alignment = MAX2(alignment, image->planes[0].nil.align_B);
          pte_kind = image->planes[0].nil.pte_kind;
          tile_mode = image->planes[0].nil.tile_mode;
-      } else if (image != NULL && image->can_compress) {
-         /* If it's a dedicated alloc and it's not modifiers, then it's marked
-          * for compression and larger pages, so we set the pinned bit and up
-          * the alignment.
+      } else if (image != NULL && image->can_compress && not_shared) {
+         /* If it's a dedicated alloc and it's not modifiers or shared, then
+          * it's marked for compression and larger pages, so we set the pinned
+          * bit and up the alignment.
+          *
+          * Disabling compression for export/import is a bit nicer to apps.
+          * Eg. QtWebEngine likes to export/import buffers with
+          * VK_IMAGE_TILING_OPTIMAL and renders incorrectly if we remove
+          * the not_shared check.
+          * https://qt-project.atlassian.net/browse/QTBUG-141866
           */
          pinned_to_vram = true;
          pte_kind = image->planes[0].nil.compressed_pte_kind;
diff --git a/src/nouveau/vulkan/nvk_image.c b/src/nouveau/vulkan/nvk_image.c
index 4418ad7d252..4da561e5501 100644
--- a/src/nouveau/vulkan/nvk_image.c
+++ b/src/nouveau/vulkan/nvk_image.c
@@ -1421,8 +1421,10 @@ nvk_image_plane_bind(struct nvk_device *dev,
                                 &plane_size_B, &plane_align_B);
    *offset_B = align64(*offset_B, plane_align_B);
 
+   const bool not_shared = !(mem->mem->flags & NVKMD_MEM_SHARED);
+
    if (plane->nil.pte_kind != 0) {
-      if (mem->dedicated_image == image && image->can_compress) {
+      if (mem->dedicated_image == image && image->can_compress && not_shared) {
          image->is_compressed = true;
          plane->addr = mem->mem->va->addr + *offset_B;
       } else {
-- 
2.51.0

